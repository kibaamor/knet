language: cpp

jobs:
  include:
    - os: linux
      dist: bionic
      env: GCC_VERSION=5
    - os: linux
      dist: bionic
      env: GCC_VERSION=6
    - os: linux
      dist: bionic
      env: GCC_VERSION=7
    - os: linux
      dist: bionic
      env: GCC_VERSION=8
    - os: linux
      dist: bionic
      env: GCC_VERSION=9
    - os: linux
      dist: bionic
      env: GCC_VERSION=10
    - os: linux
      dist: bionic
      env: GCC_VERSION=11

    - os: linux
      dist: bionic
      env: CLANG_VERSION=5.0
    - os: linux
      dist: bionic
      env: CLANG_VERSION=6.0
    - os: linux
      dist: bionic
      env: CLANG_VERSION=7
    - os: linux
      dist: bionic
      env: CLANG_VERSION=8
    - os: linux
      dist: bionic
      env: CLANG_VERSION=9
    - os: linux
      dist: bionic
      env: CLANG_VERSION=10
    - os: linux
      dist: bionic
      env: CLANG_VERSION=11
    - os: linux
      dist: bionic
      env: CLANG_VERSION=12
    - os: linux
      dist: bionic
      env: CLANG_VERSION=13

    # osx image list https://docs.travis-ci.com/user/reference/osx/#macos-version
    - os: osx
      osx_image: xcode9.4
    - os: osx
      osx_image: xcode10.3
    - os: osx
      osx_image: xcode11.6
    - os: osx
      osx_image: xcode12.5

    # FreeBSD
    - os: freebsd

install:
  - |
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      CMAKE_URL="https://cmake.org/files/v3.15/cmake-3.15.7-Linux-x86_64.sh"
      wget -qO /tmp/cmake.sh $CMAKE_URL
      sh /tmp/cmake.sh --prefix=/tmp/ --exclude-subdir --skip-license
      echo "export PATH=/tmp/bin/:/usr/local/bin:/usr/bin:$PATH" > /tmp/knet.env

      if [[ "$GCC_VERSION" != "" ]]; then
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo apt-get -q update
        sudo apt-get -yq install g++-$GCC_VERSION

        echo "export CC=gcc-$GCC_VERSION CXX=g++-$GCC_VERSION" >> /tmp/knet.env
      fi

      if [[ "$CLANG_VERSION" != "" ]]; then
        curl -sSL "https://apt.llvm.org/llvm-snapshot.gpg.key" | sudo apt-key add -
        echo "deb https://apt.llvm.org/bionic/ llvm-toolchain-bionic-$CLANG_VERSION main" | sudo tee -a ${TRAVIS_ROOT}/etc/apt/sources.list >/dev/null
        sudo apt-get -q update
        sudo apt-get -yq install clang-$CLANG_VERSION

        echo "export CC=clang-$CLANG_VERSION CXX=clang++-$CLANG_VERSION" >> /tmp/knet.env
      fi
    fi

before_script:
  - |
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      cat /tmp/knet.env
      source /tmp/knet.env
    fi
  - printenv
  - ${CC} --version
  - ${CXX} --version
  - cmake --version

script:
  # Generate project
  - cmake . -B build

  # Debug
  - cmake --build build --clean-first --config Debug
  - (cd build && ctest --output-on-failure)

  # Release
  - cmake --build build --clean-first --config Release
  - (cd build && ctest --output-on-failure)

  # MinSizeRel
  - cmake --build build --clean-first --config MinSizeRel
  - (cd build && ctest --output-on-failure)

  # RelWithDebInfo
  - cmake --build build --clean-first --config RelWithDebInfo
  - (cd build && ctest --output-on-failure)
